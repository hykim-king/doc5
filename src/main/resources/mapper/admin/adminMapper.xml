<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.doc5.mapper.AdMapper">
    <resultMap id="mapMypageOrderVO" type="MypageOrderVO">
<id property="orderNo" column="order_no"/>
        <result property="branchCode" column="branch_code"/>
        <result property="orderName" column="order_name"/>
        <result property="goodsTotalCnt" column="goods_total_cnt"/>
        <result property="settleTotalPrice" column="settle_total_price"/>
        <result property="goodsTotalPrice" column="goods_total_price"/>
        <result property="optionTotalPrice" column="option_total_price"/>
        <result property="settelKind" column="settel_kind"/>
        <result property="orderStep" column="order_step"/>
        <result property="regDt" column="reg_dt"/>
        <result property="modDt" column="mod_dt"/>
   <collection property="cList" ofType="MypageCartVO">
        <result property="seq" column="seq"/>
        <result property="goodsName" column="goods_name"/>
        <result property="goodsNo" column="goods_no"/>
        <result property="goodsPrice" column="goods_price"/>
        <result property="goodsCnt" column="goods_cnt"/>
        <result property="hotFl" column="hot_fl"/>
        <result property="hotPrice" column="hot_price"/>
        <result property="iceFl" column="ice_fl"/>
        <result property="icePrice" column="ice_price"/>
        <result property="cancelDt" column="cancel_dt"/>
     <collection property="mcgList" ofType="com.project.doc5.mypage.domain.MypageCartGoodsOptionVO">
        <result property="optionName" column="option_name"/>
        <result property="optionPrice" column="option_price"/>
     </collection>
  </collection>
  </resultMap>
    
    
    <!-- ==================== 주문 결과 매핑 ==================== -->
    <resultMap id="orderResultMap" type="com.project.doc5.manager.domain.AdOrderVO">
        <id column="ORDER_NO" property="orderNo"/>
        <result column="ORDER_DATE" property="regDt"/>
        <result column="SETTLE_TOTAL_PRICE" property="settleTotalPrice"/>
        <result column="OPTION_TOTAL_PRICE" property="optionTotalPrice"/>
        <result column="ORDER_STEP" property="orderStep"/>
        <result column="ORDER_NAME" property="orderName"/>      
    </resultMap>
    <!-- ==================== 매출/주문수 결과 매핑 ==================== -->
    <resultMap id="salesResultMap" type="com.project.doc5.manager.domain.AdOrderVO">
        <result column="TOTAL_SALES" property="totalSales"/>
        <result column="TOTAL_ORDER_COUNT" property="totalOrderCount"/>
    </resultMap>
    <!-- ==================== 지점명 매핑 ==================== -->
    <resultMap id="branchDomain"  type="com.project.doc5.branch.domain.BranchVO">
    <result column ="branch_name" property="branchName"/> 
    </resultMap>
    <select id="doDetailOrder" parameterType="MypageOrderVO" resultMap="mapMypageOrderVO"> 
    SELECT o.order_no, 
           o.branch_code, 
           o.order_name, 
           o.goods_total_cnt, 
           o.settle_total_price, 
           o.goods_total_price, 
           o.option_total_price, 
           o.settel_kind, o.order_step, 
           TO_CHAR(o.reg_dt,'MM.DD HH24:MI') reg_dt, 
           CASE WHEN o.order_step IN ('O', 'P') THEN TO_CHAR(o.mod_dt + (20/1440), 'MM.DD HH24:MI') 
           ELSE TO_CHAR(o.mod_dt, 'MM.DD HH24:MI') END AS mod_dt, 
           c.seq, c.goods_no, 
           c.goods_name, 
           c.goods_price, 
           c.goods_cnt, 
           c.hot_fl, 
           c.hot_price, 
           c.ice_fl, 
           c.ice_price, 
           cgo.option_name, 
           cgo.option_price 
           FROM doc5_order o 
           LEFT JOIN doc5_cart c ON o.order_no = c.order_no 
           LEFT JOIN doc5_cart_goods_option cgo ON c.seq = cgo.c_seq 
           WHERE o.order_no = #{orderNo} 
           ORDER BY c.seq DESC </select>
    
    <!-- ==================== 지점명 조회 ==================== -->
    <select id="getBranchName" resultMap="branchDomain">
    SELECT branch_name  
      FROM doc5_branch 
     WHERE branch_code=#{branchCode}
    
    </select>
    
    
    <!-- ==================== 월 매출 + 주문 수 ==================== -->
    <select id="selectSalesAndOrderCount"
        parameterType="java.util.Map"
        resultMap="salesResultMap">
    SELECT NVL(SUM(SETTLE_TOTAL_PRICE), 0) AS TOTAL_SALES,
           count(*) AS TOTAL_ORDER_COUNT
      FROM DOC5_ORDER
     WHERE branch_code =#{branchCode}
       AND order_step = 'S'
   <![CDATA[
       AND reg_dt >= TRUNC(SYSDATE, 'MM')
       AND reg_dt <  ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
   ]]>
     GROUP BY branch_code   
</select>
    <!-- ==================== 회원 목록 조회 ==================== -->
    <select id="selectMemberList"  resultType="com.project.doc5.user.domain.UserVO">
     SELECT user_id,
            name,
            phone,
            TO_CHAR(REG_DT, 'YYYY-MM-DD') AS reg_dt
       FROM DOC5_MEMBER
     <where>
        <if test="searchWord != null and searchWord != ''">
         AND USER_ID LIKE '%' || #{searchWord} || '%'
        </if>
        </where>
    ORDER BY REG_DT DESC
    </select>
    <!-- ==================== 회원 삭제 ==================== -->
    <delete id="deleteMemberCartData" parameterType="String">
        DELETE FROM DOC5_CART
        WHERE USER_ID = #{userId}
    </delete>
    <delete id="deleteMember" parameterType="String">
        DELETE FROM DOC5_MEMBER
        WHERE USER_ID = #{userId}
    </delete>
<select id="getPendingOrders" parameterType="com.project.doc5.manager.domain.AdDTO" resultType="com.project.doc5.manager.domain.AdOrderVO">
    SELECT * FROM (
        SELECT ROWNUM AS RNUM, A.* FROM (
            SELECT * FROM DOC5_ORDER 
            WHERE BRANCH_CODE = #{branchCode} 
              AND ORDER_STEP IN ('O', 'P')
            ORDER BY REG_DT DESC
        ) A
        WHERE ROWNUM &lt;= #{pageNo} * #{pageSize}
    ) WHERE RNUM &gt;= (#{pageNo} - 1) * #{pageSize} + 1
</select>

<select id="getOrdersByBranch" parameterType="com.project.doc5.manager.domain.AdDTO" resultType="com.project.doc5.manager.domain.AdOrderVO">
    SELECT * FROM (
        SELECT ROWNUM AS RNUM, A.* FROM (
            SELECT * FROM DOC5_ORDER 
            WHERE BRANCH_CODE = #{branchCode} 
            ORDER BY REG_DT DESC
        ) A
        WHERE ROWNUM &lt;= #{pageNo} * #{pageSize}
    ) WHERE RNUM &gt;= (#{pageNo} - 1) * #{pageSize} + 1
</select>
    <!-- ==================== 주문 상태 변경 ==================== -->
    <update id="updateOrderToSuccess" parameterType="java.util.Map">
        UPDATE DOC5_ORDER
           SET ORDER_STEP = 'S',
               MOD_DT = SYSDATE
         WHERE ORDER_NO = #{orderNo}
           AND ORDER_STEP = 'P'
           AND BRANCH_CODE = #{branchCode}
    </update>
    <update id="updateOrderToCancel" parameterType="java.util.Map">
        UPDATE DOC5_ORDER
           SET ORDER_STEP = 'C',
               MOD_DT = SYSDATE
         WHERE ORDER_NO = #{orderNo}
           AND ORDER_STEP IN ('O','P')
           AND BRANCH_CODE = #{branchCode}
    </update>   
    
    <update id="updateOrderToP" parameterType="java.util.Map"> 
    UPDATE DOC5_ORDER 
       SET ORDER_STEP = 'P', 
           MOD_DT = SYSDATE 
     WHERE ORDER_NO = #{orderNo} 
       AND ORDER_STEP = 'O' 
       AND BRANCH_CODE = #{branchCode} 
    </update> 
    
    <select id ="getCountPO">
    SELECT count(*)
      FROM DOC5_ORDER
     WHERE BRANCH_CODE = #{branchCode}
       AND ORDER_STEP IN ('O','P')
    </select>
    
    <select id ="getCountAll">
    SELECT count(*)
      FROM DOC5_ORDER
     WHERE BRANCH_CODE = #{branchCode}
    </select>
    
    
    
    
    <!-- ==================== 테스트용 INSERT ==================== -->
    <insert id="testInsertMember"
            parameterType="com.project.doc5.user.domain.UserVO">
        INSERT INTO DOC5_MEMBER (
            USER_ID, NAME, PASSWORD, PHONE,
            GRADE, REG_DT, PRIVACY_DT
        ) VALUES (
            #{userId},
            #{name},
            #{password},
            #{phone},
            DECODE(#{grade},
                   'BASIC', 1,
                   'SILVER', 2,
                   'GOLD', 3),
            SYSDATE,
            SYSDATE
        )
    </insert>
    <insert id="testInsertOrder"
            parameterType="com.project.doc5.manager.domain.AdOrderVO">
        INSERT INTO DOC5_ORDER (
            ORDER_NO, BRANCH_CODE, ORDER_NAME, GOODS_TOTAL_CNT,
            SETTLE_TOTAL_PRICE, GOODS_TOTAL_PRICE, OPTION_TOTAL_PRICE,
            SETTEL_KIND, ORDER_STEP, REG_DT, MOD_DT
        ) VALUES (
            #{orderNo}, #{branchCode}, #{orderName}, #{goodsTotalCnt},
            #{settleTotalPrice}, #{goodsTotalPrice}, #{optionTotalPrice},
            #{settelKind}, #{orderStep}, SYSDATE, SYSDATE
        )
    </insert>
    <insert id="testInsertCart" parameterType="java.util.Map">
        INSERT INTO DOC5_CART (
            SEQ, ORDER_NO, USER_ID, GOODS_NO,
            BRANCH_CODE, GOODS_NAME
        ) VALUES (
            (SELECT NVL(MAX(SEQ), 0) + 1 FROM DOC5_CART),
            #{orderNo}, #{userId}, 10000,
            #{branchCode}, #{goodsName}
        )
    </insert>
</mapper>